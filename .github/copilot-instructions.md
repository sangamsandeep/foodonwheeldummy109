# Copilot Instructions for QR Ordering System

- **Project snapshot:** Monorepo with Express API (`apps/api`) and Next.js 14 app router frontend (`apps/web`); PostgreSQL via Prisma; Stripe for payments; Twilio for SMS/voice.
- **Run locally (dev):** Terminal 1 `docker-compose up`; Terminal 2 `stripe listen --forward-to http://localhost:3001/api/stripe/webhook`; Terminal 3 `cd apps/api && npm run dev`; Terminal 4 `cd apps/web && npm run dev`. Root helpers: `npm run dev` (both via concurrently), `npm run build`, `npm run prisma:migrate`, `npm run prisma:studio`.
- **Env/Secrets:** Required vars validated in [apps/api/src/config/env.ts](apps/api/src/config/env.ts) (DATABASE_URL, STRIPE_*, TWILIO_*, OTP_SECRET_PEPPER). `STAFF_PASSWORD` defaults to `admin123` if unset; set strong value. `BASE_URL`/`FRONTEND_URL` drive CORS and webhook URLs.
- **Data model:** Prisma schema + migrations in [apps/api/prisma](apps/api/prisma). Prices, fees, profits stored in cents; order items snapshot name/price/cost at creation for historical accuracy. Order/payment statuses are enums.
- **API architecture:** Express app wired in [apps/api/src/index.ts](apps/api/src/index.ts) with global rate limit and CORS. Stripe webhook route uses `express.raw`—do not place JSON body middleware ahead of it. 404 + error handlers already present.
- **Validation/auth:** All inputs parsed with Zod schemas in [apps/api/src/utils/validation.ts](apps/api/src/utils/validation.ts). Staff endpoints guard via `X-Staff-Password` header in [apps/api/src/middleware/auth.ts](apps/api/src/middleware/auth.ts). OTP endpoints additionally rate-limited in [apps/api/src/middleware/rateLimiter.ts](apps/api/src/middleware/rateLimiter.ts).
- **Checkout creation:** [apps/api/src/routes/checkout.ts](apps/api/src/routes/checkout.ts) recalculates totals server-side from Prisma menu data, creates orders with PENDING payment, builds Stripe Checkout sessions, and persists `stripeCheckoutSessionId`. Add new cart fields here and keep calculations authoritative on the server.
- **Payment webhook:** [apps/api/src/routes/stripe.ts](apps/api/src/routes/stripe.ts) verifies signatures with `STRIPE_WEBHOOK_SECRET`, marks orders PAID/PLACED, generates OTP, sends SMS (if consented), computes stripe + comm costs, profit, and creates payment rows. Any changes must keep metadata `orderId`/`storeId` aligned with checkout.
- **Staff flow:** [apps/api/src/routes/staff.ts](apps/api/src/routes/staff.ts) enforces paid status before status changes, triggers Twilio call on READY, logs call costs, and clears OTP hash on completion. Resend OTP regenerates hash/expiry and resets attempts.
- **OTP handling:** OTPs are 6-digit codes hashed with HMAC-SHA256 + `OTP_SECRET_PEPPER` in [apps/api/src/services/otp.ts](apps/api/src/services/otp.ts); expiry 60 minutes; 5-attempt limit. Never store or log plain OTP beyond SMS body.
- **Comms:** SMS sending in [apps/api/src/services/sms.ts](apps/api/src/services/sms.ts); voice call + TwiML generation in [apps/api/src/services/voice.ts](apps/api/src/services/voice.ts). Costs are currently estimated at 1¢ per SMS/call and rolled into `commCostCents`.
- **Profit logic:** Fee math in [apps/api/src/services/payment.ts](apps/api/src/services/payment.ts); profit aggregation/reporting in [apps/api/src/services/profit.ts](apps/api/src/services/profit.ts) (daily summary and item reports). Maintain cents arithmetic to avoid rounding errors.
- **Frontend patterns:** Next.js app router pages under [apps/web/app](apps/web/app). Store page [apps/web/app/store/[slug]/page.tsx](apps/web/app/store/[slug]/page.tsx) keeps cart client-side and calls API helpers in [apps/web/lib/api.ts](apps/web/lib/api.ts). Staff dashboard [apps/web/app/staff/page.tsx](apps/web/app/staff/page.tsx) authenticates by fetching orders; all staff API calls must include `X-Staff-Password` and `storeId`.
- **UX rules:** Checkout UI enforces E.164 phone format and explicit SMS/call consent in [apps/web/components/Cart.tsx](apps/web/components/Cart.tsx). Menu cards and order status live in [apps/web/components](apps/web/components).
- **Database workflows:** Use `npx prisma migrate dev` for local schema changes, `prisma migrate deploy` for prod, and `npm run seed` (root or `apps/api` scripts) to reseed sample data; Prisma Studio via `npm run prisma:studio` is the fastest way to get Store ID.
- **Testing aids:** Follow scenarios in [TESTING.md](TESTING.md) and smoke checks in [STARTUP_CHECKLIST.md](STARTUP_CHECKLIST.md); use Stripe test cards and Twilio verified numbers. Health check at `/health`.
- **Security reminders:** Keep raw body for Stripe, never trust client pricing, secure STAFF_PASSWORD/OTP_SECRET_PEPPER, and ensure CORS `FRONTEND_URL` matches deployment domain. Add richer auth/rate limits before production.
